<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>馬來西亞旅遊行程</title>

  

  <style>
    body {
      background: #f6f5f3;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .app {
      width: 380px;
      background: #fff;
      border-radius: 20px;
      padding: 20px;
    }
    .days {
      display: flex;
      overflow-x: auto;
      gap: 6px;
      margin-bottom: 12px;
    }
    .day-btn {
      padding: 6px 10px;
      border-radius: 12px;
      border: none;
      background: #eee;
      cursor: pointer;
    }
    .day-btn.active {
      background: #e5d5c3;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin: 10px 0;
    }
    .tab {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: none;
      background: #eee;
      cursor: pointer;
    }
    .tab.active {
      background: #e8dcca;
    }
    .card {
      background: #faf9f7;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 10px;
    }
    .add-btn {
      width: 100%;
      margin: 12px 0;
      padding: 10px;
      border-radius: 12px;
      border: none;
      background: #d9cbb6;
      cursor: pointer;
    }
  </style>
</head>

<body>
<div class="app">
  <div class="days" id="dayButtons"></div>
  <h1 id="dayTitle"></h1>

  <div class="tabs">
    <button class="tab active" data-category="spot">景點</button>
    <button class="tab" data-category="food">美食</button>
    <button class="tab" data-category="stay">住宿</button>
  </div>

  <div id="schedule"></div>
  <button class="add-btn" onclick="addPlace()">＋ 新增地點</button>

  <hr>

<h2>待辦事項</h2>
<ul id="todoList"></ul>
<button class="add-btn" onclick="addTodo()">＋ 新增待辦</button>

<h2>行李清單</h2>
<ul id="luggageList"></ul>
<button class="add-btn" onclick="addLuggage()">＋ 新增行李</button>

<h2>購物清單</h2>
<ul id="shoppingList"></ul>
<button class="add-btn" onclick="addShopping()">＋ 新增購物</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// ===== Firebase 初始化 =====
const firebaseConfig = {
  apiKey: "你的 apiKey",
  authDomain: "你的 authDomain",
  projectId: "你的 projectId",
  storageBucket: "你的 storageBucket",
  messagingSenderId: "你的 messagingSenderId",
  appId: "你的 appId"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== 行程資料 =====
const days = [
  { date: "2/9", city: "台灣出發" },
  { date: "2/10", city: "麻六甲" },
  { date: "2/11", city: "波德申" },
  { date: "2/12", city: "波德申" },
  { date: "2/13", city: "KL" },
  { date: "2/14", city: "KL" },
  { date: "2/15", city: "梳邦" },
  { date: "2/16", city: "回台灣" }
];

let currentDay = 0;
let currentCategory = "spot";

// 每一天自己的行程 + 待辦
const data = days.map(() => ({
  spot: [],
  food: [],
  stay: [],
  todo: []
}));

const luggage = [];
const shopping = [];

// ===== Firebase Collections =====
const todoColl = collection(db, "todo");
const luggageColl = collection(db, "luggage");
const shoppingColl = collection(db, "shopping");
const scheduleColl = collection(db, "schedule");

// ===== 工具函數 =====
function renderListWithDelete(id, arr, firebaseColl, extra = {}) {
  const ul = document.getElementById(id);
  ul.innerHTML = "";
  arr.forEach((item, index) => {
    const li = document.createElement("li");
    li.textContent = item.text ?? item;
    
    const delBtn = document.createElement("button");
    delBtn.textContent = "❌";
    delBtn.style.marginLeft = "10px";
    delBtn.onclick = async () => {
      arr.splice(index, 1);
      ul.removeChild(li);
      if (item.id) {
        await deleteDoc(doc(db, firebaseColl.path, item.id));
      }
    };
    li.appendChild(delBtn);
    ul.appendChild(li);
  });
}

// ===== Day 按鈕 =====
function renderDayButtons() {
  const container = document.getElementById("dayButtons");
  container.innerHTML = "";
  days.forEach((day, idx) => {
    const btn = document.createElement("button");
    btn.className = "day-btn";
    if (idx === currentDay) btn.classList.add("active");
    btn.textContent = `Day ${idx + 1}`;
    btn.onclick = () => {
      currentDay = idx;
      updateActiveDay();
      renderSchedule();
      renderScheduleItems();
      renderTodo();
      scrollActiveDayIntoView();
    };
    container.appendChild(btn);
  });
}

function updateActiveDay() {
  document.querySelectorAll(".day-btn").forEach((btn, idx) => {
    btn.classList.toggle("active", idx === currentDay);
  });
  scrollActiveDayIntoView();
}

function scrollActiveDayIntoView() {
  const container = document.getElementById("dayButtons");
  const activeBtn = container.querySelector(".day-btn.active");
  if (activeBtn) activeBtn.scrollIntoView({ behavior: "smooth", inline: "center" });
}

// ===== Schedule & Tab =====
function renderSchedule() {
  document.getElementById("dayTitle").textContent = `${days[currentDay].date} ${days[currentDay].city}`;
}

function renderScheduleItems() {
  const container = document.getElementById("schedule");
  container.innerHTML = "";
  const items = data[currentDay][currentCategory];
  items.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "card";
    div.textContent = item.text ?? item;

    const delBtn = document.createElement("button");
    delBtn.textContent = "❌";
    delBtn.style.marginLeft = "10px";
    delBtn.onclick = async () => {
      items.splice(index, 1);
      div.remove();
      if (item.id) await deleteDoc(doc(db, scheduleColl.path, item.id));
    };
    div.appendChild(delBtn);
    container.appendChild(div);
  });
}

// Tab 切換
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    currentCategory = tab.dataset.category;
    renderScheduleItems();
  });
});

// ===== 新增項目 =====
async function saveToFirebase(coll, obj) {
  try {
    const docRef = await addDoc(coll, obj);
    obj.id = docRef.id; // 記錄 ID 方便刪除
    return obj;
  } catch (e) {
    console.error("❌ 新增失敗", e);
  }
}

window.addPlace = async function() {
  const t = prompt("新增地點");
  if (t) {
    const obj = await saveToFirebase(scheduleColl, { text: t, day: currentDay, category: currentCategory });
    data[currentDay][currentCategory].push(obj);
    renderScheduleItems();
  }
};

window.addTodo = async function() {
  const t = prompt("待辦事項");
  if (t) {
    const obj = await saveToFirebase(todoColl, { text: t, day: currentDay });
    data[currentDay].todo.push(obj);
    renderTodo();
  }
};

window.addLuggage = async function() {
  const t = prompt("行李項目");
  if (t) {
    const obj = await saveToFirebase(luggageColl, { text: t });
    luggage.push(obj);
    renderListWithDelete("luggageList", luggage, luggageColl);
  }
};

window.addShopping = async function() {
  const t = prompt("購物項目");
  if (t) {
    const obj = await saveToFirebase(shoppingColl, { text: t });
    shopping.push(obj);
    renderListWithDelete("shoppingList", shopping, shoppingColl);
  }
};

// ===== 渲染 =====
function renderTodo() {
  renderListWithDelete("todoList", data[currentDay].todo, todoColl);
}

// ===== 初始化 =====
(async function init() {
  // 載入 Firebase 的資料
  const loadData = async (coll, targetArr, dayKey = null, categoryKey = null) => {
    const snapshot = await getDocs(coll);
    snapshot.forEach(docSnap => {
      const item = docSnap.data();
      item.id = docSnap.id;
      if (dayKey !== null && categoryKey !== null) {
        targetArr[item.day][item.category].push(item);
      } else {
        targetArr.push(item);
      }
    });
  };

  await loadData(todoColl, data, "day", "todo");
  await loadData(luggageColl, luggage);
  await loadData(shoppingColl, shopping);
  await loadData(scheduleColl, data, "day", "category");

  renderDayButtons();
  renderSchedule();
  renderScheduleItems();
  renderTodo();
  renderListWithDelete("luggageList", luggage, luggageColl);
  renderListWithDelete("shoppingList", shopping, shoppingColl);
})();
</script>

</body>
</html>
