<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é¦¬ä¾†è¥¿äºæ—…éŠè¡Œç¨‹</title>

  <style>
    body {
      background: #f6f5f3;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .app {
      width: 380px;
      background: #fff;
      border-radius: 20px;
      padding: 20px;
    }
    .days {
      display: flex;
      overflow-x: auto;
      gap: 6px;
      margin-bottom: 12px;
    }
    .day-btn {
      padding: 6px 10px;
      border-radius: 12px;
      border: none;
      background: #eee;
      cursor: pointer;
    }
    .day-btn.active {
      background: #e5d5c3;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin: 10px 0;
    }
    .tab {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: none;
      background: #eee;
      cursor: pointer;
    }
    .tab.active {
      background: #e8dcca;
    }
    .card {
      background: #faf9f7;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 10px;
    }
    .add-btn {
      width: 100%;
      margin: 12px 0;
      padding: 10px;
      border-radius: 12px;
      border: none;
      background: #d9cbb6;
      cursor: pointer;
    }
  </style>
</head>

<body>
<div class="app">
  <div class="days" id="dayButtons"></div>
  <h1 id="dayTitle"></h1>

  <div class="tabs">
    <button class="tab active" data-category="spot">æ™¯é»</button>
    <button class="tab" data-category="food">ç¾é£Ÿ</button>
    <button class="tab" data-category="stay">ä½å®¿</button>
  </div>

  <div id="schedule"></div>
  <button class="add-btn" onclick="addPlace()">ï¼‹ æ–°å¢åœ°é»</button>

  <hr>

<h2>å¾…è¾¦äº‹é …</h2>
<ul id="todoList"></ul>
<button class="add-btn" onclick="addTodo()">ï¼‹ æ–°å¢å¾…è¾¦</button>

<h2>è¡Œææ¸…å–®</h2>
<ul id="luggageList"></ul>
<button class="add-btn" onclick="addLuggage()">ï¼‹ æ–°å¢è¡Œæ</button>

<h2>è³¼ç‰©æ¸…å–®</h2>
<ul id="shoppingList"></ul>
<button class="add-btn" onclick="addShopping()">ï¼‹ æ–°å¢è³¼ç‰©</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// ===== Firebase åˆå§‹åŒ– =====
const firebaseConfig = {
  apiKey: "AIzaSyBOTh16RSCCca_FBUFiz0utDil-SlkZJKg",
  authDomain: "travel-plan-544b5.firebaseapp.com",
  projectId: "travel-plan-544b5",
  storageBucket: "travel-plan-544b5.firebasestorage.app",
  messagingSenderId: "794197854377",
  appId: "1:794197854377:web:5ac7eb18afb56618cf01b8",
  measurementId: "G-YQLWLZ66CS"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== Day èˆ‡è³‡æ–™ =====
const days = [
  { date: "2/9", city: "å°ç£å‡ºç™¼" },
  { date: "2/10", city: "é¦¬å…­ç”²" },
  { date: "2/11", city: "æ³¢å¾·ç”³" },
  { date: "2/12", city: "æ³¢å¾·ç”³" },
  { date: "2/13", city: "å‰éš†å¡" },
  { date: "2/14", city: "å‰éš†å¡" },
  { date: "2/15", city: "æ¢³é‚¦" },
  { date: "2/16", city: "å›å°ç£" }
];
let currentDay = 0;
let currentCategory = "spot";

// æ¯ä¸€å¤©è³‡æ–™
const data = days.map(() => ({ spot: [], food: [], stay: [], todo: [] }));
const luggage = [];
const shopping = [];

// Firebase Collections
const scheduleColl = collection(db, "schedule");
const todoColl = collection(db, "todo");
const luggageColl = collection(db, "luggage");
const shoppingColl = collection(db, "shopping");

// ===== æ¸²æŸ“å·¥å…· =====
function renderScheduleItems() {
  const container = document.getElementById("schedule");
  container.innerHTML = "";
  const items = data[currentDay][currentCategory] || [];
  items.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "card";

    const text = document.createElement("div");
    text.textContent = item.text;

    const mapBtn = document.createElement("button");
    mapBtn.textContent = "ğŸ“ æŸ¥çœ‹åœ°åœ–";
    mapBtn.style.marginTop = "6px";
    mapBtn.onclick = () => {
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.text)}`;
      window.open(url, "_blank");
    };

    const delBtn = document.createElement("button");
    delBtn.textContent = "X";
    delBtn.style.marginLeft = "10px";
    delBtn.onclick = async () => {
      items.splice(index, 1);
      div.remove();
      if(item.id) await deleteDoc(doc(db, scheduleColl.path, item.id));
    };

    div.appendChild(text);
    div.appendChild(mapBtn);
    div.appendChild(delBtn);
    container.appendChild(div);
  });
}

function renderListWithDelete(id, arr, coll) {
  const container = document.getElementById(id);
  container.innerHTML = "";
  arr.forEach((item, index) => {
    const li = document.createElement("li");
    li.textContent = item.text;

    const delBtn = document.createElement("button");
    delBtn.textContent = "X";
    delBtn.style.marginLeft = "10px";
    delBtn.onclick = async () => {
      arr.splice(index, 1);
      li.remove();
      if(item.id) await deleteDoc(doc(db, coll.path, item.id));
    };

    li.appendChild(delBtn);
    container.appendChild(li);
  });
}

function renderTodo() {
  renderListWithDelete("todoList", data[currentDay].todo, todoColl);
}

// ===== Day æŒ‰éˆ• =====
function renderDayButtons() {
  const container = document.getElementById("dayButtons");
  container.innerHTML = "";
  days.forEach((day, idx) => {
    const btn = document.createElement("button");
    btn.className = "day-btn";
    if(idx === currentDay) btn.classList.add("active");
    btn.textContent = `Day ${idx + 1}`;
    btn.onclick = () => {
      currentDay = idx;
      updateActiveDay();
      renderSchedule();
      renderScheduleItems();
      renderTodo();
      scrollActiveDayIntoView();
    };
    container.appendChild(btn);
  });
}

function updateActiveDay() {
  document.querySelectorAll(".day-btn").forEach((btn, idx) => {
    btn.classList.toggle("active", idx === currentDay);
  });
}

function scrollActiveDayIntoView() {
  const container = document.getElementById("dayButtons");
  const activeBtn = container.querySelector(".day-btn.active");
  if(activeBtn) activeBtn.scrollIntoView({ behavior: "smooth", inline: "center" });
}

function renderSchedule() {
  document.getElementById("dayTitle").textContent = `${days[currentDay].date} ${days[currentDay].city}`;
}

// Tab åˆ‡æ›
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    currentCategory = tab.dataset.category;
    renderScheduleItems();
  });
});

// ===== æ–°å¢é …ç›® =====
async function saveToFirebase(coll, obj) {
  try {
    const docRef = await addDoc(coll, obj);
    obj.id = docRef.id;
    return obj;
  } catch(e) {
    alert("æ–°å¢å¤±æ•—ï¼Œç¢ºèª Firebase æ¬Šé™");
    console.error("æ–°å¢å¤±æ•—", e);
    return null;
  }
}

window.addPlace = async function() {
  const t = prompt("æ–°å¢åœ°é»");
  if(t && t.trim() !== "") {
    await saveToFirebase(scheduleColl, { text: t, day: currentDay, category: currentCategory });
    // ä¸å†æ‰‹å‹• push
  }
};

window.addTodo = async function() {
  const t = prompt("å¾…è¾¦äº‹é …");
  if(t && t.trim() !== "") {
    await saveToFirebase(todoColl, { text: t, day: currentDay });
  }
};

window.addLuggage = async function() {
  const t = prompt("è¡Œæé …ç›®");
  if(t && t.trim() !== "") {
    await saveToFirebase(luggageColl, { text: t });
  }
};

window.addShopping = async function() {
  const t = prompt("è³¼ç‰©é …ç›®");
  if(t && t.trim() !== "") {
    await saveToFirebase(shoppingColl, { text: t });
  }
};

// ===== Firebase ç›£è½ =====
function setupFirebaseListeners() {
  // è¡Œç¨‹
  onSnapshot(scheduleColl, snapshot => {
    snapshot.docChanges().forEach(change => {
      const item = change.doc.data();
      item.id = change.doc.id;
      if(change.type === "added") {
        if(!data[item.day][item.category].some(i => i.id === item.id)){
          data[item.day][item.category].push(item);
        }
      } else if(change.type === "removed") {
        data[item.day][item.category] = data[item.day][item.category].filter(i => i.id !== item.id);
      }
    });
    renderScheduleItems();
  });

  // å¾…è¾¦
  onSnapshot(todoColl, snapshot => {
    snapshot.docChanges().forEach(change => {
      const item = change.doc.data();
      item.id = change.doc.id;
      const dayIndex = Number(item.day);
      if(change.type === "added") {
        if(!data[dayIndex].todo.some(i => i.id === item.id)){
          data[dayIndex].todo.push(item);
        }
      } else if(change.type === "removed") {
        data[dayIndex].todo = data[dayIndex].todo.filter(i => i.id !== item.id);
      }
    });
    renderTodo();
  });

  // è¡Œæ
  onSnapshot(luggageColl, snapshot => {
    snapshot.docChanges().forEach(change => {
      const item = change.doc.data();
      item.id = change.doc.id;
      if(change.type === "added") {
        if(!luggage.some(i => i.id === item.id)) luggage.push(item);
      } else if(change.type === "removed") {
        const idx = luggage.findIndex(i => i.id === item.id);
        if(idx !== -1) luggage.splice(idx,1);
      }
    });
    renderListWithDelete("luggageList", luggage, luggageColl);
  });

  // è³¼ç‰©
  onSnapshot(shoppingColl, snapshot => {
    snapshot.docChanges().forEach(change => {
      const item = change.doc.data();
      item.id = change.doc.id;
      if(change.type === "added") {
        if(!shopping.some(i => i.id === item.id)) shopping.push(item);
      } else if(change.type === "removed") {
        const idx = shopping.findIndex(i => i.id === item.id);
        if(idx !== -1) shopping.splice(idx,1);
      }
    });
    renderListWithDelete("shoppingList", shopping, shoppingColl);
  });
}

// ===== åˆå§‹åŒ– =====
async function init() {
  renderDayButtons();
  renderSchedule();
  setupFirebaseListeners();
}

init();
</script>

</body>
</html>
