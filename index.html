<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>馬來西亞旅遊行程</title>
<style>
body{font-family:sans-serif;background:#f6f5f3;display:flex;flex-direction:column;align-items:center;padding:20px;}
.title-card{background:#f3e9d2;padding:12px 20px;border-radius:16px;text-align:center;font-size:26px;font-weight:600;margin-bottom:20px;color:#b3cccc;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
.app{width:380px;background:#fff;border-radius:20px;padding:20px;}
.days{display:flex;overflow-x:auto;gap:6px;margin-bottom:12px;}
.day-btn{padding:6px 10px;border-radius:12px;border:none;background:#eee;cursor:pointer;}
.day-btn.active{background:#e5d5c3;}
.tabs{display:flex;gap:8px;margin:10px 0;}
.tab{flex:1;padding:8px;border-radius:20px;border:none;background:#eee;cursor:pointer;}
.tab.active{background:#e8dcca;}
.card{background:#faf9f7;padding:12px;border-radius:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.add-btn{width:100%;margin:12px 0;padding:10px;border-radius:12px;border:none;background:#d9cbb6;cursor:pointer;}
ul{padding-left:20px;} li{margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;}
</style>
</head>
<body>
<div class="title-card">范家與李媽媽的馬來西亞旅遊行程</div>
<div class="app">
  <div class="days" id="dayButtons"></div>
  <h2 id="dayTitle"></h2>

  <!-- 景點、美食、住宿 tabs -->
  <div class="tabs">
    <button class="tab active" data-category="spot">景點</button>
    <button class="tab" data-category="food">美食</button>
    <button class="tab" data-category="stay">住宿</button>
  </div>
  <div id="schedule"></div>
  <button class="add-btn" onclick="addPlace()">＋ 新增地點</button>

  <hr>
  <h2>待辦事項</h2>
  <ul id="todoList"></ul>
  <button class="add-btn" onclick="addTodo()">＋ 新增待辦</button>

  <h2>行李清單</h2>
  <ul id="luggageList"></ul>
  <button class="add-btn" onclick="addLuggage()">＋ 新增行李</button>

  <h2>購物清單</h2>
  <ul id="shoppingList"></ul>
  <button class="add-btn" onclick="addShopping()">＋ 新增購物</button>
</div>

<script>
// 基本資料
const days = [
  {date:"2/9", city:"台灣出發"},
  {date:"2/10", city:"馬六甲"},
  {date:"2/11", city:"波德申"},
  {date:"2/12", city:"吉隆坡"},
  {date:"2/13", city:"吉隆坡"},
  {date:"2/14", city:"梳邦"},
  {date:"2/15", city:"梳邦"},
  {date:"2/16", city:"回台灣"}
];

let currentDay = 0;
let currentCategory = "spot";

// 統一資料結構
let data = days.map(()=>({spot:[], food:[], stay:[], todo:[]}));
let luggage = [];
let shopping = [];

// -------------------------
// 1️⃣ 抓所有資料
async function fetchAllData(){
  try {
    // 行程
    const scheduleRes = await fetch("https://travel-plan-malaysia.onrender.com/schedule");
    if(!scheduleRes.ok) throw new Error("抓行程失敗");
    const scheduleData = await scheduleRes.json();
    scheduleData.forEach(item=>{
      if(data[item.day] && item.category in data[item.day]){
        data[item.day][item.category].push(item);
      }
    });

    // 待辦
    const todoRes = await fetch("https://travel-plan-malaysia.onrender.com/todo");
    if(!todoRes.ok) throw new Error("抓待辦失敗");
    const todoData = await todoRes.json();
    todoData.forEach(item=>{
      if(data[item.day] && item.category === "todo") data[item.day].todo.push(item);
    });

    // 行李
    const luggageRes = await fetch("https://travel-plan-malaysia.onrender.com/luggage");
    if(!luggageRes.ok) throw new Error("抓行李失敗");
    luggage = await luggageRes.json();

    // 購物
    const shoppingRes = await fetch("https://travel-plan-malaysia.onrender.com/shopping");
    if(!shoppingRes.ok) throw new Error("抓購物失敗");
    shopping = await shoppingRes.json();

  } catch(err){
    console.error("抓資料出錯：", err);
  }
}

// -------------------------
// 2️⃣ 渲染按鈕
function renderDayButtons(){
  const c = document.getElementById("dayButtons"); c.innerHTML = "";
  days.forEach((_, idx)=>{
    const b = document.createElement("button");
    b.className = "day-btn" + (idx===currentDay?" active":"");
    b.textContent = `Day ${idx+1}`;
    b.onclick = ()=>{
      currentDay = idx;
      updateActiveDay();
      renderCurrentView();
    };
    c.appendChild(b);
  });
}

function updateActiveDay(){
  document.querySelectorAll(".day-btn").forEach((b,i)=>b.classList.toggle("active", i===currentDay));
}

// -------------------------
// 3️⃣ 渲染行程
function renderScheduleItems(){
  const dayInfo = days[currentDay];
  document.getElementById("dayTitle").textContent = `${dayInfo.date} ${dayInfo.city}`;
  const c = document.getElementById("schedule"); c.innerHTML = "";
  data[currentDay][currentCategory].forEach((item,i)=>{
    const card = document.createElement("div"); card.className="card";
    const t = document.createElement("div"); t.textContent = item.text;
    const delBtn = document.createElement("button"); delBtn.textContent = "X";
    delBtn.onclick = async ()=>{
      try{
        await fetch(`https://travel-plan-malaysia.onrender.com/${currentCategory}/${item.id}`, {method:'DELETE'});
        data[currentDay][currentCategory].splice(i,1);
        renderScheduleItems();
      } catch(err){ console.error(err); }
    };
    card.append(t, delBtn); c.appendChild(card);
  });
}

// -------------------------
// 4️⃣ 渲染清單
function renderList(id, arr, category){
  const ul = document.getElementById(id); ul.innerHTML="";
  arr.forEach((item,i)=>{
    const li = document.createElement("li");
    li.textContent = item.text;
    const delBtn = document.createElement("button"); delBtn.textContent="X";
    delBtn.onclick = async ()=>{
      try{
        await fetch(`https://travel-plan-malaysia.onrender.com/${category}/${item.id}`, {method:'DELETE'});
        arr.splice(i,1);
        renderList(id,arr,category);
      } catch(err){ console.error(err); }
    };
    li.appendChild(delBtn); ul.appendChild(li);
  });
}

// -------------------------
// 5️⃣ 新增功能
async function addPlace(){
  const t = prompt("新增地點"); if(!t) return;
  try{
    const res = await fetch("https://travel-plan-malaysia.onrender.com/schedule",{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text:t, category:currentCategory, day:currentDay})
    });
    const obj = await res.json();
    data[currentDay][currentCategory].push(obj);
    renderScheduleItems();
  } catch(err){ console.error(err); }
}

async function addTodo(){
  const t = prompt("新增待辦"); if(!t) return;
  try{
    const res = await fetch("https://travel-plan-malaysia.onrender.com/todo",{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text:t, day:currentDay, category:"todo"})
    });
    const obj = await res.json();
    data[currentDay].todo.push(obj);
    renderList("todoList", data[currentDay].todo, "todo");
  } catch(err){ console.error(err); }
}

async function addLuggage(){
  const t = prompt("新增行李"); if(!t) return;
  try{
    const res = await fetch("https://travel-plan-malaysia.onrender.com/luggage",{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text:t})
    });
    const obj = await res.json();
    luggage.push(obj);
    renderList("luggageList", luggage, "luggage");
  } catch(err){ console.error(err); }
}

async function addShopping(){
  const t = prompt("新增購物"); if(!t) return;
  try{
    const res = await fetch("https://travel-plan-malaysia.onrender.com/shopping",{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text:t})
    });
    const obj = await res.json();
    shopping.push(obj);
    renderList("shoppingList", shopping, "shopping");
  } catch(err){ console.error(err); }
}

// -------------------------
// 6️⃣ tabs 切換
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    currentCategory = tab.dataset.category;
    renderScheduleItems();
  }
});

// -------------------------
// 7️⃣ 初始化
async function init(){
  renderDayButtons();
  await fetchAllData();
  renderCurrentView();
}

function renderCurrentView(){
  renderScheduleItems();
  renderList("todoList", data[currentDay].todo, "todo");
  renderList("luggageList", luggage, "luggage");
  renderList("shoppingList", shopping, "shopping");
}

init();
</script>

</script>
</body>
</html>
